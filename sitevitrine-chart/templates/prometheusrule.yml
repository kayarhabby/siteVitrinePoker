{{- if and .Values.monitoring.enabled .Values.monitoring.prometheusRule.enabled }}
# --------------------------
# PrometheusRule - Alertes pour SiteVitrine
# --------------------------
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ .Values.app.name }}-alerts
  labels:
    app: {{ .Values.app.name }}
    release: prometheus
    {{- include "sitevitrine.labels" . | nindent 4 }}
spec:
  groups:

    # ----------------------------
    # Alertes Application Spring Boot
    # ----------------------------
    - name: sitevitrine.app.rules
      interval: 30s
      rules:
        - alert: SiteVitrineAppDown
          expr: up{job="{{ .Values.app.name }}-svc"} == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: SiteVitrine est inaccessible
            description: >-
              L instance {{ "{{" }} $labels.instance {{ "}}" }} est down depuis plus d 1 minute.

        - alert: SiteVitrineHighErrorRate
          expr: >-
            rate(http_server_requests_seconds_count{status=~"5..",
            job="{{ .Values.app.name }}-svc"}[5m]) > 0.1
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: Taux d erreurs HTTP 5xx eleve
            description: >-
              Plus de 10% des requetes retournent des erreurs 5xx sur
              {{ "{{" }} $labels.instance {{ "}}" }}.

        - alert: SiteVitrineHighLatency
          expr: >-
            histogram_quantile(0.95,
              rate(http_server_requests_seconds_bucket{job="{{ .Values.app.name }}-svc"}[5m])
            ) > 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: Latence P95 trop elevee
            description: >-
              95% des requetes prennent plus de 2 secondes sur
              {{ "{{" }} $labels.instance {{ "}}" }}.

        - alert: SiteVitrineHighJvmHeap
          expr: >-
            jvm_memory_used_bytes{area="heap", job="{{ .Values.app.name }}-svc"}
            / jvm_memory_max_bytes{area="heap", job="{{ .Values.app.name }}-svc"} > 0.85
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: JVM Heap usage eleve
            description: >-
              Le heap JVM depasse 85% sur {{ "{{" }} $labels.instance {{ "}}" }}.

    # ----------------------------
    # Alertes MySQL
    # ----------------------------
    - name: sitevitrine.mysql.rules
      rules:
        - alert: SiteVitrineMySQLDown
          expr: up{job="{{ .Values.mysql.name }}-svc"} == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: MySQL SiteVitrine est inaccessible
            description: MySQL est down depuis plus d 1 minute.

    # ----------------------------
    # Alertes Noeuds (node-exporter)
    # ----------------------------
    - name: sitevitrine.node.rules
      rules:
        - alert: NodeHighCPU
          expr: >-
            100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: CPU noeud eleve
            description: >-
              Le noeud {{ "{{" }} $labels.instance {{ "}}" }} utilise plus de 85% de CPU depuis 5 min.

        - alert: NodeHighMemory
          expr: >-
            (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: RAM noeud elevee
            description: >-
              Le noeud {{ "{{" }} $labels.instance {{ "}}" }} utilise plus de 85% de memoire.

        - alert: NodeDiskAlmostFull
          expr: >-
            (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"}
            / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"})) * 100 > 80
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: Disque noeud presque plein
            description: >-
              Le disque {{ "{{" }} $labels.mountpoint {{ "}}" }} sur
              {{ "{{" }} $labels.instance {{ "}}" }} est plein a plus de 80%.

        - alert: NodeNotReady
          expr: kube_node_status_condition{condition="Ready",status="true"} == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: Noeud Kubernetes non pret
            description: >-
              Le noeud {{ "{{" }} $labels.node {{ "}}" }} est en etat NotReady depuis plus de 2 min.

    # ----------------------------
    # Alertes Pods (kube-state-metrics)
    # ----------------------------
    - name: sitevitrine.pod.rules
      rules:
        - alert: PodCrashLooping
          expr: >-
            rate(kube_pod_container_status_restarts_total{namespace=~".*sitevitrine.*|default"}[5m])
            * 60 > 0.5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: Pod en CrashLoopBackOff
            description: >-
              Le conteneur {{ "{{" }} $labels.container {{ "}}" }} dans le pod
              {{ "{{" }} $labels.pod {{ "}}" }} redemarre trop frequemment.

        - alert: PodNotRunning
          expr: >-
            kube_pod_status_phase{phase!~"Running|Succeeded",
            namespace=~".*sitevitrine.*|default"} == 1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: Pod non en etat Running
            description: >-
              Le pod {{ "{{" }} $labels.pod {{ "}}" }} est en phase
              {{ "{{" }} $labels.phase {{ "}}" }} depuis plus de 10 min.

        - alert: DeploymentReplicasMismatch
          expr: >-
            kube_deployment_spec_replicas{namespace=~".*sitevitrine.*|default"}
            != kube_deployment_status_replicas_available{namespace=~".*sitevitrine.*|default"}
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: Deployment sous-dimensionne
            description: >-
              Le deployment {{ "{{" }} $labels.deployment {{ "}}" }}
              n a pas le bon nombre de replicas disponibles.

        - alert: PVCNotBound
          expr: kube_persistentvolumeclaim_status_phase{phase!="Bound"} == 1
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: PVC non lie
            description: >-
              Le PVC {{ "{{" }} $labels.persistentvolumeclaim {{ "}}" }} n est pas en etat Bound.
{{- end }}